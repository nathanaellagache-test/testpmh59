<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - Patrouilles de S√©curit√©</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066FF;
            --success: #00C48C;
            --warning: #FFB020;
            --danger: #FF3B30;
            --bg-main: #F8F9FB;
            --bg-card: #FFFFFF;
            --text-primary: #1A1D29;
            --text-secondary: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
        }

        /* PAGE DE CONNEXION */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .login-box {
            background: var(--bg-card);
            padding: 48px 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 420px;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, #0052CC 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 20px;
            box-shadow: 0 8px 20px rgba(0, 102, 255, 0.3);
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            transition: all 0.2s ease;
            background: var(--bg-main);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-card);
            box-shadow: 0 0 0 4px rgba(0, 102, 255, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary) 0%, #0052CC 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 102, 255, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .error-message {
            background: #FEE2E2;
            color: #991B1B;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .error-message.show {
            display: block;
        }

        /* DASHBOARD */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header responsive */
        header {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            border-left: 4px solid var(--primary);
        }

        .header-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-content h1 {
            font-size: clamp(20px, 5vw, 28px);
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: clamp(12px, 3vw, 14px);
        }

        .logout-btn {
            padding: 10px 20px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .logout-btn:hover {
            background: #CC3028;
            transform: translateY(-1px);
        }

        /* SYST√àME D'ONGLETS */
        .tabs-container {
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .tabs-header {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            border-bottom: 2px solid var(--border);
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        .tabs-header::-webkit-scrollbar {
            height: 4px;
        }

        .tabs-header::-webkit-scrollbar-track {
            background: var(--bg-main);
        }

        .tabs-header::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }

        .tab-btn {
            flex: 0 0 auto;
            padding: 16px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: var(--primary);
            background: var(--bg-main);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: var(--bg-main);
        }

        .tab-content {
            display: none;
            padding: 24px;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Grille de statistiques responsive */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: clamp(24px, 5vw, 36px);
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-card.success {
            border-left-color: var(--success);
        }

        .stat-card.warning {
            border-left-color: var(--warning);
        }

        .stat-card.danger {
            border-left-color: var(--danger);
        }

        /* Graphiques responsive */
        .chart-container {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .bar-item {
            margin-bottom: 16px;
        }

        .bar-label {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .bar-wrapper {
            background: var(--bg-main);
            border-radius: 8px;
            height: 32px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, #00A876 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 12px;
            color: white;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            transition: width 0.5s ease;
            min-width: 40px;
        }

        .bar-fill.danger {
            background: linear-gradient(90deg, var(--danger) 0%, #CC3028 100%);
        }

        /* Alerte responsive */
        .alert-box {
            background: linear-gradient(135deg, #FFF4E6 0%, #FFE8CC 100%);
            border: 2px solid var(--warning);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .alert-box h2 {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: clamp(16px, 4vw, 18px);
            font-weight: 700;
            color: #B45309;
            margin-bottom: 16px;
        }

        .alert-icon {
            width: 32px;
            height: 32px;
            background: var(--warning);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .priority-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .priority-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            gap: 12px;
            flex-wrap: wrap;
        }

        .priority-rank {
            background: var(--warning);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 700;
            margin-right: 8px;
        }

        /* Filtres responsive */
        .filters {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-select {
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            background: var(--bg-main);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #0052CC;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-main);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Tableau responsive */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            min-width: 600px;
        }

        thead {
            background: var(--bg-main);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 16px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: var(--bg-main);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-success {
            background: #D1FAE5;
            color: #065F46;
        }

        .badge-danger {
            background: #FEE2E2;
            color: #991B1B;
        }

        /* √âtats de chargement */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            margin: 0 auto 16px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            display: none;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 18px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* MEDIA QUERIES */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            header {
                padding: 16px;
            }

            .header-wrapper {
                flex-direction: column;
                align-items: flex-start;
            }

            .logout-btn {
                width: 100%;
            }

            .tabs-container {
                margin-left: -12px;
                margin-right: -12px;
                border-radius: 0;
            }

            .tab-content {
                padding: 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                padding: 16px;
            }

            .filters {
                padding: 16px;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .filter-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .login-box {
                padding: 32px 24px;
            }

            .priority-item {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        @media (max-width: 480px) {
            .tab-btn {
                padding: 12px 16px;
                font-size: 13px;
            }

            th, td {
                padding: 12px 8px;
                font-size: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .alert-box {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- PAGE DE CONNEXION -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="login-header">
                <div class="login-icon">üõ°Ô∏è</div>
                <h1 class="login-title">Connexion S√©curis√©e</h1>
                <p class="login-subtitle">Acc√®s au tableau de bord des patrouilles</p>
            </div>

            <div class="error-message" id="errorMessage">
                Mot de passe incorrect
            </div>

            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="password" autofocus>
            </div>

            <button class="login-btn" onclick="checkPassword()">Se connecter</button>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div class="dashboard" id="dashboardPage">
        <div class="container">
            <header>
                <div class="header-wrapper">
                    <div class="header-content">
                        <h1>üìä Tableau de Bord - Patrouilles</h1>
                        <p class="subtitle">Surveillance et analyse des secteurs de passage</p>
                    </div>
                    <button class="logout-btn" onclick="logout()">üîì D√©connexion</button>
                </div>
            </header>

            <!-- SYST√àME D'ONGLETS -->
            <div class="tabs-container">
                <div class="tabs-header">
                    <button class="tab-btn active" onclick="switchTab('vue-globale')">üìà Vue Globale</button>
                    <!-- Les onglets secteurs seront cr√©√©s dynamiquement ici -->
                    <button class="tab-btn" onclick="switchTab('donnees')">üìã Donn√©es Compl√®tes</button>
                </div>

                <!-- ONGLET VUE GLOBALE -->
                <div class="tab-content active" id="vue-globale">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Patrouilles</div>
                            <div class="stat-value" id="totalPatrols">0</div>
                        </div>
                        <div class="stat-card danger">
                            <div class="stat-label">Total Incidents</div>
                            <div class="stat-value" id="totalIncidents">0</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-label">Taux d'Incidents</div>
                            <div class="stat-value" id="incidentRate">0%</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-label">Agents Actifs</div>
                            <div class="stat-value" id="activeAgents">0</div>
                        </div>
                    </div>

                    <div id="alertBox"></div>

                    <div class="chart-container">
                        <h3 class="chart-title">üìç Incidents par Lieu</h3>
                        <div id="locationChart"></div>
                    </div>
                </div>

                <!-- Les onglets secteurs seront cr√©√©s dynamiquement ici -->

                <!-- ONGLET DONN√âES COMPL√àTES -->
                <div class="tab-content" id="donnees">
                    <div class="filters">
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label class="filter-label">Date d√©but</label>
                                <input type="date" class="filter-select" id="filterDateStart">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Date fin</label>
                                <input type="date" class="filter-select" id="filterDateEnd">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Lieu</label>
                                <select class="filter-select" id="filterLocation">
                                    <option value="">Tous les lieux</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Statut</label>
                                <select class="filter-select" id="filterStatus">
                                    <option value="">Tous</option>
                                    <option value="oui">Incidents</option>
                                    <option value="non">RAS</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" onclick="applyFilters()">üîç Filtrer</button>
                            <button class="btn btn-secondary" onclick="resetFilters()">üîÑ R√©initialiser</button>
                        </div>
                    </div>

                    <div id="loading" class="loading">
                        <div class="spinner"></div>
                        <p style="color: var(--text-secondary);">Chargement des donn√©es...</p>
                    </div>

                    <div id="emptyState" class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>Aucune donn√©e trouv√©e</h3>
                        <p>Aucune patrouille ne correspond √† vos crit√®res de recherche.</p>
                    </div>

                    <div id="tableContainer" style="display: none;">
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>üìÖ Date</th>
                                        <th>üïê Heure</th>
                                        <th>üìç Lieu</th>
                                        <th>‚ö†Ô∏è Statut</th>
                                        <th>üìù √âv√©nement</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        const SHEET_ID = '1qJzPzulKJaqISwFEd3Lsms8UYl0gk2Q3gkNT61CFWn4';
        const SHEET_NAME = 'Feuille 1';
        
        // üîê MOT DE PASSE (√† changer !)
        // Pour g√©n√©rer un hash SHA-256 de votre mot de passe, utilisez : https://emn178.github.io/online-tools/sha256.html
        const PASSWORD_HASH = 'aadd8f53894ddd7be36a1dbb7ed89a398525eeb312eac9336c359ed332023e11'; // Par d√©faut: "password"
        
        let allData = [];
        let filteredData = [];
        let isAuthenticated = false;
        let currentTab = 'vue-globale';

        // ========== SYST√àME D'ONGLETS ==========
        function switchTab(tabName) {
            // Masquer tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Afficher l'onglet s√©lectionn√©
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            currentTab = tabName;

            // Mettre √† jour les donn√©es pour le secteur
            if (tabName.startsWith('secteur-')) {
                updateSectorStats(tabName);
            }
        }

        // ========== AUTHENTIFICATION ==========
        async function hashPassword(password) {
            const msgBuffer = new TextEncoder().encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function checkPassword() {
            const passwordInput = document.getElementById('password');
            const password = passwordInput.value;
            const errorMessage = document.getElementById('errorMessage');

            const hash = await hashPassword(password);
            
            if (hash === PASSWORD_HASH) {
                isAuthenticated = true;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboardPage').classList.add('active');
                loadData();
            } else {
                errorMessage.classList.add('show');
                passwordInput.value = '';
                passwordInput.focus();
                setTimeout(() => {
                    errorMessage.classList.remove('show');
                }, 3000);
            }
        }

        function logout() {
            isAuthenticated = false;
            document.getElementById('dashboardPage').classList.remove('active');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('password').value = '';
        }

        // Permettre la soumission avec Enter
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // ========== CHARGEMENT DES DONN√âES ==========
        async function loadData() {
            if (!isAuthenticated) return;

            try {
                // Utiliser l'export CSV public de Google Sheets (pas besoin de cl√© API)
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
                
                const response = await fetch(url);
                const csvText = await response.text();
                
                // Parser le CSV
                const lines = csvText.split('\n');
                const data = [];
                
                if (lines.length < 2) {
                    showEmptyState();
                    return;
                }
                
                // Lire la premi√®re ligne pour obtenir les en-t√™tes
                const headerLine = lines[0].trim();
                const headers = parseCSVLine(headerLine).map(h => h.replace(/"/g, '').toLowerCase().trim());
                
                console.log('En-t√™tes d√©tect√©s:', headers);
                
                // Trouver les index des colonnes importantes
                const dateIndex = findColumnIndex(headers, ['date']);
                const heureIndex = findColumnIndex(headers, ['heure de passage', 'heure']);
                const lieuIndex = findColumnIndex(headers, ['quel lieu avez-vous s√©curis√©', 'lieu']);
                const faitIndex = findColumnIndex(headers, ['avez-vous constat√© un fait', 'fait']);
                const mainCouranteIndex = findColumnIndex(headers, ['n¬∞ de main courante', 'main courante']);
                const evenementIndex = findColumnIndex(headers, ['quel fait avez-vous constat√©', 'fait avez-vous constat√©']);
                const agentIndex = findColumnIndex(headers, ['matricule agent', 'agent']);
                
                console.log('Index trouv√©s - Date:', dateIndex, 'Heure:', heureIndex, 'Lieu:', lieuIndex, 'Fait:', faitIndex, 'MainCourante:', mainCouranteIndex, '√âv√©nement:', evenementIndex, 'Agent:', agentIndex);
                
                // V√©rifier que les colonnes essentielles sont trouv√©es
                if (dateIndex === -1 || lieuIndex === -1) {
                    document.getElementById('loading').innerHTML = `
                        <p style="color: var(--danger);">‚ö†Ô∏è Erreur de configuration</p>
                        <p style="font-size: 13px; margin-top: 8px;">Colonnes 'Date' et 'Lieu' non trouv√©es dans la feuille.</p>
                        <p style="font-size: 12px; margin-top: 8px; color: var(--text-secondary);">En-t√™tes d√©tect√©s: ${headers.join(', ')}</p>
                    `;
                    return;
                }
                
                // Parser les donn√©es en utilisant les index trouv√©s
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const values = parseCSVLine(line);
                    
                    // V√©rifier que la ligne a assez de colonnes
                    if (values.length > Math.max(dateIndex, lieuIndex)) {
                        const dateValue = values[dateIndex]?.replace(/"/g, '') || '';
                        const lieuValue = values[lieuIndex]?.replace(/"/g, '') || '';
                        
                        // Ne garder que les lignes avec au minimum une date et un lieu
                        if (dateValue && lieuValue) {
                            data.push({
                                date: dateValue,
                                heure: heureIndex !== -1 ? (values[heureIndex]?.replace(/"/g, '') || '') : '',
                                lieu: lieuValue,
                                fait: faitIndex !== -1 ? (values[faitIndex]?.replace(/"/g, '') || 'non') : 'non',
                                agent: agentIndex !== -1 ? (values[agentIndex]?.replace(/"/g, '') || '') : '',
                                evenement: evenementIndex !== -1 ? (values[evenementIndex]?.replace(/"/g, '') || '') : ''
                            });
                        }
                    }
                }
                
                console.log('Donn√©es charg√©es:', data.length, 'lignes');
                
                if (data.length > 0) {
                    allData = data;
                    filteredData = [...allData];
                    updateDashboard();
                    updateAllSectors();
                    populateFilters();
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('tableContainer').style.display = 'block';
                } else {
                    showEmptyState();
                }
            } catch (error) {
                console.error('Erreur lors du chargement des donn√©es:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: var(--danger);">‚ö†Ô∏è Erreur de connexion</p>
                    <p style="font-size: 13px; margin-top: 8px;">V√©rifiez que la feuille Google est publique.</p>
                `;
            }
        }

        // Fonction pour trouver l'index d'une colonne par son nom
        function findColumnIndex(headers, possibleNames) {
            for (let name of possibleNames) {
                const index = headers.findIndex(h => {
                    // Nettoyer les espaces et caract√®res sp√©ciaux pour la comparaison
                    const cleanHeader = h.replace(/\s+/g, ' ').trim().toLowerCase();
                    const cleanName = name.replace(/\s+/g, ' ').trim().toLowerCase();
                    return cleanHeader.includes(cleanName) || cleanName.includes(cleanHeader);
                });
                if (index !== -1) return index;
            }
            return -1;
        }

        // Parser une ligne CSV en g√©rant les guillemets
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            
            return result;
        }

        // ========== MISE √Ä JOUR DU DASHBOARD ==========
        function updateDashboard() {
            if (filteredData.length === 0) {
                showEmptyState();
                return;
            }

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';

            const totalPatrols = filteredData.length;
            const totalIncidents = filteredData.filter(d => d.fait.toLowerCase() === 'oui').length;
            const incidentRate = totalPatrols > 0 ? ((totalIncidents / totalPatrols) * 100).toFixed(1) : 0;
            const uniqueAgents = new Set(filteredData.map(d => d.agent).filter(a => a)).size;

            document.getElementById('totalPatrols').textContent = totalPatrols;
            document.getElementById('totalIncidents').textContent = totalIncidents;
            document.getElementById('incidentRate').textContent = incidentRate + '%';
            document.getElementById('activeAgents').textContent = uniqueAgents;

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = filteredData.map(row => `
                <tr>
                    <td>${row.date}</td>
                    <td>${row.heure}</td>
                    <td><strong>${row.lieu}</strong></td>
                    <td>
                        ${row.fait.toLowerCase() === 'oui' 
                            ? '<span class="badge badge-danger">‚ö†Ô∏è Incident</span>' 
                            : '<span class="badge badge-success">‚úì RAS</span>'}
                    </td>
                    <td>${row.evenement || '-'}</td>
                </tr>
            `).join('');

            updateLocationChart();
            updatePriorityAlert();
        }

        function updateLocationChart() {
            const locationStats = {};
            
            filteredData.forEach(row => {
                if (!locationStats[row.lieu]) {
                    locationStats[row.lieu] = { total: 0, incidents: 0 };
                }
                locationStats[row.lieu].total++;
                if (row.fait.toLowerCase() === 'oui') {
                    locationStats[row.lieu].incidents++;
                }
            });

            const sortedLocations = Object.entries(locationStats)
                .sort((a, b) => b[1].incidents - a[1].incidents)
                .slice(0, 8);

            const maxIncidents = Math.max(...sortedLocations.map(([_, stats]) => stats.incidents), 1);

            const chartHTML = sortedLocations.map(([lieu, stats]) => {
                const percentage = (stats.incidents / maxIncidents) * 100;
                const isDanger = stats.incidents > 0;
                return `
                    <div class="bar-item">
                        <div class="bar-label">${lieu}</div>
                        <div class="bar-wrapper">
                            <div class="bar-fill ${isDanger ? 'danger' : ''}" style="width: ${percentage}%">
                                ${stats.incidents}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('locationChart').innerHTML = chartHTML || '<p style="text-align: center; color: var(--text-secondary);">Aucune donn√©e disponible</p>';
        }

        function updatePriorityAlert() {
            const locationStats = {};
            
            allData.forEach(row => {
                if (!locationStats[row.lieu]) {
                    locationStats[row.lieu] = 0;
                }
                if (row.fait.toLowerCase() === 'oui') {
                    locationStats[row.lieu]++;
                }
            });

            const topLocations = Object.entries(locationStats)
                .filter(([_, count]) => count > 0)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);

            if (topLocations.length > 0) {
                const alertHTML = `
                    <div class="alert-box">
                        <h2>
                            <span class="alert-icon">!</span>
                            Recommandation : Renforcer la pr√©sence
                        </h2>
                        <div class="priority-list">
                            ${topLocations.map(([lieu, count], index) => `
                                <div class="priority-item">
                                    <div>
                                        <span class="priority-rank">#${index + 1}</span>
                                        <strong>${lieu}</strong>
                                    </div>
                                    <div style="font-family: 'JetBrains Mono', monospace; font-weight: 600;">
                                        ${count} fait${count > 1 ? 's' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                document.getElementById('alertBox').innerHTML = alertHTML;
            } else {
                document.getElementById('alertBox').innerHTML = '';
            }
        }

        // ========== MISE √Ä JOUR DES SECTEURS ==========
        function updateAllSectors() {
            // Obtenir tous les lieux uniques des donn√©es
            const allLocations = [...new Set(allData.map(d => d.lieu))].sort();
            
            // Cr√©er dynamiquement les onglets secteurs bas√©s sur les lieux
            createSectorTabs(allLocations);
            
            // Mettre √† jour les statistiques de chaque secteur
            allLocations.forEach((location, index) => {
                updateSectorStats(`secteur-${index}`, location);
            });
        }

        function createSectorTabs(locations) {
            const tabsHeader = document.querySelector('.tabs-header');
            
            // Garder seulement les onglets "Vue Globale" et "Donn√©es Compl√®tes"
            const vueGlobaleBtn = tabsHeader.querySelector('.tab-btn');
            
            // Supprimer tous les onglets secteurs existants
            const existingSectorBtns = tabsHeader.querySelectorAll('.tab-btn:not(:first-child):not(:last-child)');
            existingSectorBtns.forEach(btn => btn.remove());
            
            const existingSectorContents = document.querySelectorAll('.tab-content[id^="secteur-"]');
            existingSectorContents.forEach(content => content.remove());
            
            // Cr√©er les nouveaux onglets pour chaque lieu
            locations.forEach((location, index) => {
                // Cr√©er le bouton d'onglet
                const tabBtn = document.createElement('button');
                tabBtn.className = 'tab-btn';
                tabBtn.textContent = `üìç ${location}`;
                tabBtn.onclick = () => switchTab(`secteur-${index}`);
                
                // Ins√©rer avant l'onglet "Donn√©es Compl√®tes"
                const donneesBtn = tabsHeader.querySelector('.tab-btn:last-child');
                tabsHeader.insertBefore(tabBtn, donneesBtn);
                
                // Cr√©er le contenu de l'onglet
                const tabContent = document.createElement('div');
                tabContent.className = 'tab-content';
                tabContent.id = `secteur-${index}`;
                tabContent.innerHTML = `
                    <div class="filters">
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label class="filter-label">Date d√©but</label>
                                <input type="date" class="filter-select" id="filterDateStart-${index}">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Date fin</label>
                                <input type="date" class="filter-select" id="filterDateEnd-${index}">
                            </div>
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" onclick="applySectorFilters('secteur-${index}', '${location}')">üîç Filtrer</button>
                            <button class="btn btn-secondary" onclick="resetSectorFilters('secteur-${index}', '${location}')">üîÑ R√©initialiser</button>
                        </div>
                    </div>
                    <div class="stats-grid" id="stats-secteur-${index}"></div>
                    <div class="chart-container">
                        <h3 class="chart-title">üìä R√©partition des incidents - ${location}</h3>
                        <div id="chart-secteur-${index}"></div>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">‚è∞ R√©partition Horaire</h3>
                        <div id="time-chart-secteur-${index}"></div>
                    </div>
                `;
                
                // Ins√©rer avant l'onglet "Donn√©es Compl√®tes"
                const donneesContent = document.getElementById('donnees');
                donneesContent.parentNode.insertBefore(tabContent, donneesContent);
                
                // Ajouter les event listeners pour les filtres de date
                setTimeout(() => {
                    document.getElementById(`filterDateStart-${index}`).addEventListener('change', () => applySectorFilters(`secteur-${index}`, location));
                    document.getElementById(`filterDateEnd-${index}`).addEventListener('change', () => applySectorFilters(`secteur-${index}`, location));
                }, 100);
            });
        }

        function updateSectorStats(sectorId, location) {
            // Si location n'est pas fourni, le r√©cup√©rer depuis l'ID
            if (!location) {
                const sectorIndex = parseInt(sectorId.split('-')[1]);
                const allLocations = [...new Set(allData.map(d => d.lieu))].sort();
                location = allLocations[sectorIndex];
            }
            
            // R√©cup√©rer les filtres de date pour ce secteur
            const sectorIndex = sectorId.split('-')[1];
            const dateStartFilter = document.getElementById(`filterDateStart-${sectorIndex}`)?.value || '';
            const dateEndFilter = document.getElementById(`filterDateEnd-${sectorIndex}`)?.value || '';
            
            // Filtrer les donn√©es pour ce lieu sp√©cifique avec la plage de dates
            let sectorData = allData.filter(row => row.lieu === location);
            
            // Appliquer le filtre de dates si pr√©sent
            if (dateStartFilter || dateEndFilter) {
                sectorData = sectorData.filter(row => {
                    const normalizedRowDate = normalizeDate(row.date);
                    if (dateStartFilter && normalizedRowDate < dateStartFilter) return false;
                    if (dateEndFilter && normalizedRowDate > dateEndFilter) return false;
                    return true;
                });
            }

            if (sectorData.length === 0) {
                document.getElementById(`stats-${sectorId}`).innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">Aucune donn√©e pour cette p√©riode</p>';
                document.getElementById(`chart-${sectorId}`).innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Aucune donn√©e disponible</p>';
                document.getElementById(`time-chart-${sectorId}`).innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Aucune donn√©e disponible</p>';
                return;
            }

            const totalPatrols = sectorData.length;
            const incidents = sectorData.filter(d => d.fait.toLowerCase() === 'oui').length;
            const incidentRate = ((incidents / totalPatrols) * 100).toFixed(1);
            const uniqueAgents = new Set(sectorData.map(d => d.agent).filter(a => a)).size;

            // Stats cards
            document.getElementById(`stats-${sectorId}`).innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Patrouilles</div>
                    <div class="stat-value">${totalPatrols}</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-label">Incidents</div>
                    <div class="stat-value">${incidents}</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-label">Taux d'Incidents</div>
                    <div class="stat-value">${incidentRate}%</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-label">Agents</div>
                    <div class="stat-value">${uniqueAgents}</div>
                </div>
            `;

            // Graphique de statut (RAS vs Incidents)
            updateSectorStatusChart(sectorId, sectorData);

            // Graphique horaire
            updateSectorTimeChart(sectorId, sectorData);
        }

        // Appliquer les filtres pour un secteur sp√©cifique
        function applySectorFilters(sectorId, location) {
            updateSectorStats(sectorId, location);
        }

        // R√©initialiser les filtres pour un secteur sp√©cifique
        function resetSectorFilters(sectorId, location) {
            const sectorIndex = sectorId.split('-')[1];
            document.getElementById(`filterDateStart-${sectorIndex}`).value = '';
            document.getElementById(`filterDateEnd-${sectorIndex}`).value = '';
            updateSectorStats(sectorId, location);
        }

        function updateSectorStatusChart(sectorId, data) {
            const incidents = data.filter(d => d.fait.toLowerCase() === 'oui').length;
            const ras = data.length - incidents;
            const total = data.length;

            const chartHTML = `
                <div class="bar-item">
                    <div class="bar-label">RAS (Rien √† Signaler)</div>
                    <div class="bar-wrapper">
                        <div class="bar-fill" style="width: ${(ras/total)*100}%">
                            ${ras} patrouille${ras > 1 ? 's' : ''}
                        </div>
                    </div>
                </div>
                <div class="bar-item">
                    <div class="bar-label">Incidents signal√©s</div>
                    <div class="bar-wrapper">
                        <div class="bar-fill danger" style="width: ${(incidents/total)*100}%">
                            ${incidents} incident${incidents > 1 ? 's' : ''}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById(`chart-${sectorId}`).innerHTML = chartHTML;
        }

        function updateSectorTimeChart(sectorId, data) {
            const timeStats = {};
            
            data.forEach(row => {
                const hour = row.heure.split(':')[0];
                if (!timeStats[hour]) {
                    timeStats[hour] = { total: 0, incidents: 0 };
                }
                timeStats[hour].total++;
                if (row.fait.toLowerCase() === 'oui') {
                    timeStats[hour].incidents++;
                }
            });

            const sortedTimes = Object.entries(timeStats)
                .sort((a, b) => a[0].localeCompare(b[0]));

            if (sortedTimes.length === 0) {
                document.getElementById(`time-chart-${sectorId}`).innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Aucune donn√©e horaire disponible</p>';
                return;
            }

            const maxValue = Math.max(...sortedTimes.map(([_, stats]) => stats.total), 1);

            const chartHTML = sortedTimes.map(([hour, stats]) => {
                const percentage = (stats.total / maxValue) * 100;
                const hasIncidents = stats.incidents > 0;
                return `
                    <div class="bar-item">
                        <div class="bar-label">${hour}:00 (${stats.incidents} incident${stats.incidents > 1 ? 's' : ''})</div>
                        <div class="bar-wrapper">
                            <div class="bar-fill ${hasIncidents ? 'danger' : ''}" style="width: ${percentage}%">
                                ${stats.total}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById(`time-chart-${sectorId}`).innerHTML = chartHTML;
        }

        // ========== FILTRES ==========
        function populateFilters() {
            const locations = [...new Set(allData.map(d => d.lieu))].sort();
            const locationSelect = document.getElementById('filterLocation');
            locationSelect.innerHTML = '<option value="">Tous les lieux</option>' + 
                locations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
        }

        function applyFilters() {
            const dateStartFilter = document.getElementById('filterDateStart').value;
            const dateEndFilter = document.getElementById('filterDateEnd').value;
            const locationFilter = document.getElementById('filterLocation').value;
            const statusFilter = document.getElementById('filterStatus').value;

            filteredData = allData.filter(row => {
                // Filtrage par plage de dates
                if (dateStartFilter || dateEndFilter) {
                    const rowDate = row.date;
                    
                    // Convertir les dates au format comparable (YYYY-MM-DD)
                    const normalizedRowDate = normalizeDate(rowDate);
                    
                    if (dateStartFilter && normalizedRowDate < dateStartFilter) return false;
                    if (dateEndFilter && normalizedRowDate > dateEndFilter) return false;
                }
                
                // Filtrage par lieu
                if (locationFilter && row.lieu !== locationFilter) return false;
                
                // Filtrage par statut
                if (statusFilter && row.fait.toLowerCase() !== statusFilter) return false;
                
                return true;
            });

            updateDashboard();
        }

        // Normaliser le format de date pour la comparaison
        function normalizeDate(dateStr) {
            // Si la date est d√©j√† au format YYYY-MM-DD
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            
            // Si la date est au format DD/MM/YYYY
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
                const [day, month, year] = dateStr.split('/');
                return `${year}-${month}-${day}`;
            }
            
            // Si la date est au format DD-MM-YYYY
            if (/^\d{2}-\d{2}-\d{4}$/.test(dateStr)) {
                const [day, month, year] = dateStr.split('-');
                return `${year}-${month}-${day}`;
            }
            
            return dateStr;
        }

        function resetFilters() {
            document.getElementById('filterDateStart').value = '';
            document.getElementById('filterDateEnd').value = '';
            document.getElementById('filterLocation').value = '';
            document.getElementById('filterStatus').value = '';
            filteredData = [...allData];
            updateDashboard();
        }

        function showEmptyState() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }

        // √âv√©nements des filtres
        document.getElementById('filterDateStart').addEventListener('change', applyFilters);
        document.getElementById('filterDateEnd').addEventListener('change', applyFilters);
        document.getElementById('filterLocation').addEventListener('change', applyFilters);
        document.getElementById('filterStatus').addEventListener('change', applyFilters);

        // Rafra√Æchir automatiquement toutes les 30 secondes
        setInterval(() => {
            if (isAuthenticated) {
                loadData();
            }
        }, 30000);
    </script>
</body>
</html>
